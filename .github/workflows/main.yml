name: Notepads CI/CD Pipeline

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      type:
        description: 'Type of filter to use ("path" for using path and "desc" for using description)'
        required: true
        default: 'path'
      reason:
        description: Reason for dismissal ("fp" for "false positive", "wf" for "won't fix" and "ut" for "used in tests")
        required: true
        default: 'wf'

jobs:
  one:
    runs-on: windows-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$env:GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJSON(job) }}
        run: echo "$env:JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJSON(steps) }}
        run: echo "$env:STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJSON(runner) }}
        run: echo "$env:RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJSON(strategy) }}
        run: echo "$env:STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJSON(matrix) }}
        run: echo "env:$MATRIX_CONTEXT"
  #setup:
  #  runs-on: windows-latest
  #  outputs:
  #    matrix: ${{ steps.set_matrix.outputs.matrix }}
  #  steps:
  #    - name: Setup strategy matrix
  #      id: set_matrix
  #      shell: pwsh
  #      run: |
  #        $MATRIX = '{
  #          "include": [
  #            {
  #              "configuration": "Production",
  #              "debug": false,
  #              "release": true
  #            }
  #          ]
  #        }'
  #        if ( ($env:GITHUB_EVENT_NAME -ceq 'pull_request') -or ($env:GITHUB_EVENT_NAME -ceq 'push') ) {
  #          $MATRIX = '{
  #            "include": [
  #              {
  #                "configuration": "Debug",
  #                "debug": true,
  #                "release": false
  #              },{
  #                "configuration": "Release",
  #                "debug": false,
  #                "release": false
  #              },{
  #                "configuration": "Production",
  #                "debug": false,
  #                "release": true
  #              }
  #            ]
  #          }'
  #        }
  #        echo "::set-output name=matrix::$($MATRIX -replace ' *\r*\n*', '')"
  #      env:
  #        GITHUB_EVENT_NAME: ${{ github.event_name }}
  ci:
    #needs: setup
    runs-on: windows-latest
    strategy:
      matrix:
        release: [test, release]
    outputs:
      new_version: "${{ steps.tag_generator.outputs.new_version }}.0"
      new_version_tag: "v${{ steps.tag_generator.outputs.new_version }}.0"
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 50
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump GitHub tag
        id: tag_generator
        uses: soumyamahunt/github-tag-action@test-other-ver-support
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          latest_ver: '1.2.3'
          dry_run: true
          default_bump: false

      - name: Bump GitHub tag og
        id: og_tag_generator
        uses: mathieudutour/github-tag-action@v5.4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          append_to_pre_release_tag: '.5'
          release_branches: release
          pre_release_branches: master, main
          default_bump: false
          dry_run: true

      - if: matrix.debug
        name: Check config type
        id: check_config
        shell: pwsh
        run: |
          echo "Debug configuration check succeded"

      - name: Use config type
        id: use_config
        shell: pwsh
        run: |
          echo "Debug configuration check succeded"
          if ($env:DEBUG -eq 'true' ) {
              echo "This is debug config"
          } else {
              echo "This is not debug config"
          }
          if ($env:RELEASE -eq 'true' ) {
              echo "This is release config"
          } else {
              echo "This is not release config"
          }
          echo "$env:MATRIX"
        env:
          DEBUG: ${{ matrix.debug }}
          RELEASE: ${{ matrix.release == 'release' || true }}
          MATRIX: ${{ toJson(github.event.inputs.matrix) }}

      - name: Update tags
        id: update_tag
        shell: pwsh
        run: |
          echo "New version is $env:NEW_VERSION"
          echo "New tag is $env:NEW_VERSION_TAG"
          echo "OG New version is $env:OG_NEW_VERSION"
          echo "OG New tag is $env:OG_NEW_VERSION_TAG"
        env:
          NEW_VERSION: "${{ steps.tag_generator.outputs.new_version }}.0"
          NEW_VERSION_TAG: "v${{ steps.tag_generator.outputs.new_version }}.0"
          OG_NEW_VERSION: "${{ steps.og_tag_generator.outputs.new_version }}.0"
          OG_NEW_VERSION_TAG: "v${{ steps.og_tag_generator.outputs.new_version }}.0"

      - name: Print changelog
        id: print_changelog
        shell: pwsh
        run: |
          echo "$env:CHANGELOG"
        env:
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}

      - name: Universal changelog
        id: universal_changelog
        uses: soumyamahunt/universal-changelog-action@master
        with:
          previousReleaseTagNameOrSha: v1.2.3.5
          nextReleaseTagName: v1.3.4.5
          nextReleaseName: Test release
          configFilePath: .github/release.json

      - name: Print universal changelog
        id: print_universal_changelog
        shell: pwsh
        run: |
          echo "$env:CHANGELOG"
        env:
          CHANGELOG: ${{ steps.universal_changelog.outputs.changelog }}

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  cd:
    needs: ci
    runs-on: windows-latest
    env:
      NEW_ASSEMBLY_VERSION: ${{ needs.ci.outputs.new_version }}
      NEW_TAG: ${{ needs.ci.outputs.new_version_tag }}
    steps:
      - name: Check output
        id: check_output
        run: |
          echo "New version is $env:NEW_ASSEMBLY_VERSION"
          echo "New tag is $env:NEW_TAG"

# Built with ‚ù§ by [Pipeline Foundation](https://pipeline.foundation)
